package com.beancounter.marketdata.broker

import com.beancounter.common.model.Portfolio
import com.beancounter.common.utils.BcJson
import com.beancounter.marketdata.event.EventProducer
import com.beancounter.marketdata.portfolio.PortfolioService
import org.awaitility.Awaitility.await
import org.junit.jupiter.api.Test
import org.mockito.Mockito.verify
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.context.SpringBootTest
import org.springframework.cloud.stream.binder.test.InputDestination
import org.springframework.cloud.stream.binder.test.TestChannelBinder.MessageCollectorConfiguration
import org.springframework.context.annotation.Import
import org.springframework.messaging.support.MessageBuilder
import org.springframework.security.oauth2.jwt.JwtDecoder
import org.springframework.test.annotation.DirtiesContext
import org.springframework.test.context.ActiveProfiles
import org.springframework.test.context.bean.override.mockito.MockitoBean
import java.math.BigDecimal
import java.util.concurrent.TimeUnit

/**
 * Test the Spring Cloud Stream consumer for Portfolio updates.
 */
@SpringBootTest(
    properties = [
        "spring.cloud.stream.defaultBinder=test",
        "spring.autoconfigure.exclude=org.springframework.cloud.stream.test.binder.TestSupportBinderAutoConfiguration"
    ]
)
@ActiveProfiles("test")
@DirtiesContext
class PortfolioKafkaListenerIntegrationTest {
    @MockitoBean
    private lateinit var jwtDecoder: JwtDecoder

    @MockitoBean
    private lateinit var eventProducer: EventProducer

    @Autowired
    private lateinit var inputDestination: InputDestination

    @MockitoBean
    private lateinit var portfolioService: PortfolioService

    @Test
    fun testStreamConsumer() {
        val portfolio =
            Portfolio(
                id = "1",
                code = "TEST",
                name = "Test Portfolio",
                marketValue = BigDecimal.TEN,
                irr = BigDecimal.ONE
            )

        // Send message via test binder
        val message = MessageBuilder.withPayload(
            BcJson.objectMapper.writeValueAsBytes(portfolio)
        ).build()

        inputDestination.send(message, "portfolioConsumer-in-0")

        // Wait for the consumer to process the message
        await()
            .atMost(
                10,
                TimeUnit.SECONDS
            ).untilAsserted {
                verify(portfolioService).maintain(portfolio)
            }
    }
}