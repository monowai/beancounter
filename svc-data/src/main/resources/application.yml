server:
  port: 9510
  servlet:
    context-path: '/api'
  shutdown: graceful
schedule:
  enabled: false

springdoc:
  use-management-port: true
  swagger-ui:
    path: /swagger-ui.html

management:
  server:
    port: 9511
  endpoint:
    health.show-details: always
  health:
    livenessstate:
      enabled: true
    readinessState:
      enabled: true
  info:
    git:
      mode: SIMPLE
  endpoints:
    web:
      exposure:
        include: "*"

sentry:
  enabled: false
  environment: local
  traces-sample-rate: .2
  debug: false

otel:
  traces:
    exporter: none
  metrics:
    exporter: none
  logs:
    exporter: none

logging:
  pattern:
    correlation: "[${spring.application.name:},%X{traceId:-},%X{spanId:-}] "
  include-application-name: false
  level:
    root: info
    javax: error
    java: error
    sun: error
    netflix: error
    jdk: error
    io:
      openttelemetry: error
      github:
        resilience4j: error
    okhttp3: error
    com:
      netfix: error
      beancounter: debug
      zaxxer: error
    org:
      aspectj: error
      springframework: error
      springframework.scheduling: info
      #springframework.security: error
      hibernate: error
      # Suppress Hibernate SQL exception logging for constraint violations
      # (handled in AssetService.create/findOrCreate catch blocks)
      hibernate.engine.jdbc.spi.SqlExceptionHelper: off
      apache: error
      postgres: error
      postgresql: error

auth:
  uri: "https://your-auth0-endpoint"
  audience: "auth0-audience"
  enabled: true
  email: "${auth.audience}/claims/email"
  # To support interactive login via the /auth endpoint
  client: "not-set"
  client-secret: "not-set"

stream:
  enabled: true

spring:
  cloud:
    function:
      definition: csvImportConsumer;trnEventConsumer;priceConsumer;portfolioConsumer
    stream:
      # Switch between kafka and rabbit using environment variable:
      # SPRING_CLOUD_STREAM_DEFAULT_BINDER=kafka (or rabbit)
      default-binder: rabbit
      bindings:
        # CSV Import Consumer
        csvImportConsumer-in-0:
          destination: bc-trn-csv-dev
          group: bc-data
          content-type: application/json
        # Transaction Event Consumer
        trnEventConsumer-in-0:
          destination: bc-trn-event-dev
          group: bc-data
          content-type: application/json
        # Price Data Consumer
        priceConsumer-in-0:
          destination: bc-price-dev
          group: bc-data
          content-type: application/json
        # Portfolio Updates Consumer
        portfolioConsumer-in-0:
          destination: bc-pos-mv-dev
          group: bc-data
          content-type: application/json
        # Corporate Event Producer (StreamBridge)
        corporateEvent-out-0:
          destination: bc-ca-event-dev
          content-type: application/json
      # Kafka-specific configuration (when default-binder=kafka)
      kafka:
        binder:
          brokers: kafka:9092
      # RabbitMQ-specific configuration (when default-binder=rabbit)
      rabbit:
        binder:
          connection-name-prefix: bc-data
  rabbitmq:
    host: localhost
    port: 5672
    username: admin
    password: admin

  security:
    oauth2:
      registration:
        custom:
          client-id: ${auth.client}
          client-secret: ${auth.client-secret}
      resourceserver:
        jwt:
          issuer-uri: ${auth.uri}
  lifecycle:
    timeout-per-shutdown-phase: 10s

  application:
    name: bc-data
  cache:
    cache-names: system.user, asset.prices, asset.search, asset.mstack.search, fx.rates, provider, providers, asset.ext, currency.code, currency.all, jwt.token, auth.m2m, alpha.asset.event, market.holidays
  flyway:
    enabled: false  # Disabled by default for H2 tests; enable in profile for PostgreSQL
    baseline-on-migrate: true
    baseline-version: 1
    locations: classpath:db/migration
  datasource:
    hikari:
      leak-detection-threshold: 20000
  jpa:
    open-in-view: false
    generate-ddl: true
    show-sql: false
    hibernate:
      ddl-auto: update
    properties:
      hibernate:
        globally_quoted_identifiers: true
        globally_quoted_identifiers_skip_column_definitions: true

  ai:
    mcp:
      server:
        name: beancounter-data
        version: 1.0.0
        type: SYNC
        stdio: false
        sse-message-endpoint: /mcp/message

# Resilience4j configuration
# Defaults are conservative for local development/free tier APIs
# Production overrides via environment variables in bc-deploy/env/kauri.yaml
resilience4j:
  ratelimiter:
    instances:
      # AlphaVantage: Free tier = 25/day, Standard = 5/min, Premium = 75/min
      # Spread requests evenly to avoid burst-prevention at AWS/NASDAQ/NYSE
      # Local dev: 1 per 12s (5/min). Production: 1 per 800ms (75/min, no bursting)
      alphaVantage:
        registerHealthIndicator: false
        limitForPeriod: 1
        limitRefreshPeriod: 12s
        timeoutDuration: 120s
        eventConsumerBufferSize: 200
      morningstar:
        registerHealthIndicator: false
        limitForPeriod: 10
        limitRefreshPeriod: 60s
        timeoutDuration: 60s
        eventConsumerBufferSize: 100
      fxRates:
        registerHealthIndicator: false
        limitForPeriod: 10
        limitRefreshPeriod: 60s
        timeoutDuration: 60s
        eventConsumerBufferSize: 200

  circuitbreaker:
    configs:
      default:
        failureRateThreshold: 50
        slidingWindowSize: 20
        permittedNumberOfCallsInHalfOpenState: 5
        slidingWindowType: COUNT_BASED
        waitDurationInOpenState: 30s
        registerHealthIndicator: true
        recordFailurePredicate: com.beancounter.common.exception.RecordFailurePredicate
  retry:
    instances:
      backend:
        maxRetryAttempts: 3
        waitDuration: 10s
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2

beancounter:
  # Default FX rate provider: FRANKFURTER (free, unlimited) or EXCHANGE_RATES_API
  fx:
    provider: EXCHANGE_RATES_API
  currency:
    base: "USD"
    values:
      - code: "GBP"
        name: "Pound"
        symbol: "£"

      - code: "USD"
        name: "Dollar"
        symbol: "$"

      - code: "NZD"
        name: "Dollar"
        symbol: "$"

      - code: "AUD"
        name: "Dollar"
        symbol: "$"

      - code: "EUR"
        name: "Euro"
        symbol: "€"

      - code: "SGD"
        name: "Dollar"
        symbol: "$"

      - code: "MYR"
        name: "Ringgit"
        symbol: "RM"

  asset:
    categories:
      default: "EQUITY"
      values:
        - id: "EQUITY"
          name: "Equity"
        - id: "CASH"
          name: "Cash"
        - id: "ETF"
          name: "Exchange Traded Fund"
        - id: "MUTUAL FUND"
          name: "Mutual Fund"
        - id: "RE"
          name: "Real Estate"
        - id: "ACCOUNT"
          name: "Bank Account"
        - id: "TRADE"
          name: "Trade Account"
        - id: "POLICY"
          name: "Insurance Policy"
        - id: "PENSION"
          name: "Pension"

  # Default asset enricher - FIGI/ALPHA - can be set on a per market basis
  enricher: ALPHA
  calendar:
    values:
      - day: "25"
        month: "12"
        markets:
          - "US"
          - "ASX"
          - "SGX"
      - day: "01"
        month: "01"
        markets:
          - "US"
          - "ASX"
          - "SGX"
      - day: "04"
        month: "07"
        markets:
          - "US"
  market:
    values:
      - code: "CASH"
        timezoneId: "UTC"
        enricher: "DEFAULT"
        type: "Internal"

      - code: "PRIVATE"
        name: "Private Assets"
        timezoneId: "UTC"
        enricher: "PRIVATE"
        type: "Private"
        aliases:
          legacy: "OFFM"

      - code: "NASDAQ"
        name: "NASDAQ"
        timezoneId: "US/Eastern"
        currencyId: "USD"
        aliases:
          SHARESIGHT: "NAS"
          FIGI: "US"

      - code: "NYSE"
        name: "New York Stock Exchange"
        timezoneId: "US/Eastern"
        currencyId: "USD"
        aliases:
          SHARESIGHT: "NYS"
          FIGI: "US"

      - code: "AMEX"
        name: "American Stock Exchange"
        timezoneId: "US/Eastern"
        currencyId: "USD"
        aliases:
          FIGI: "US"

      - code: "US"
        name: "US Market"
        timezoneId: "US/Eastern"
        currencyId: "USD"

      - code: "ASX"
        name: "Australian Securities Exchange"
        timezoneId: "Australia/Sydney"
        currencyId: "AUD"
        aliases:
          mstack: "XASX"
          sharesight: "AX"
          FIGI: "AU"

      - code: "NZX"
        name: "New Zealand Exchange"
        timezoneId: "Pacific/Auckland"
        currencyId: "NZD"
        enricher: "FIGI"
        aliases:
          mstack: "NZ"
          alpha: "NZ"
          FIGI: "NZ"

      - code: "SGX"
        name: "Singapore Exchange"
        currencyId: "SGD"
        timezoneId: "Asia/Singapore"
        enricher: "FIGI"
        aliases:
          mstack: "SI"
          FIGI: "SP"

      - code: "LON"
        name: "London Stock Exchange"
        # UK assets priced in pence.
        currencyId: "GBP"
        timezoneId: "Europe/London"
        multiplier: 0.01
        aliases:
          mstack: "XLON"
          FIGI: "LN"

      - code: "MUTF"
        name: "Mutual Funds"
        currencyId: "GBP"
        timezoneId: "Europe/London"
        enricher: "DEFAULT"
        type: "Fund"
    providers:
      alpha:
        url: https://www.alphavantage.co
        batchSize: 1
        markets: "US,NASDAQ,AMEX,NYSE,LON,NZX"

      mstack:
        url: https://api.marketstack.com
        batchSize: 10
        markets: "NZX,SGX"

      private:
        batchSize: 1
        markets: "PRIVATE"

      morningstar:
        batchSize: 1
        markets: "MUTF"

      # OpenFIGI - free, unlimited, Bloomberg-based
      figi:
        enabled: true
        # Markets that use FIGI for asset search (returns user-friendly tickers)
        search:
          markets: "NZX,SGX"

      # Frankfurter FX rates - free, unlimited, ECB-based
      frankfurter:
        url: https://api.frankfurter.app

