server:
  port: 9500
  servlet:
    context-path: '/api'

# Portfolio valuation scheduling (disabled by default for local dev)
# In production (kauri), runs every 10 mins from 5-7 AM SGT after US market close
schedule:
  enabled: false
valuation:
  schedule: "0 0/10 5-7 * * Tue-Sat"

springdoc:
  use-management-port: true

management:
  server:
    port: 9501
  endpoint:
    health:
      show-details: always
  endpoints:
    web:
      exposure:
        include: "*"
  health:
    livenessstate:
      enabled: true
    readinessState:
      enabled: true
  info:
    git:
      mode: SIMPLE

sentry:
  enabled: false
  environment: local
  traces-sample-rate: 1
  debug: false

otel:
  traces:
    exporter: none
  metrics:
    exporter: none
  logs:
    exporter: none

marketdata:
  url: "http://localhost:9510/api"
beancounter:
  irr: 365
  valuation:
    # When false, zero-quantity positions are excluded from price requests
    includeZeroQuantity: false
auth:
  uri: "http://your-auth0-endpoint/"
  audience: "auth0-audience"
  enabled: true
  email: "${auth.audience}/claims/email"
  client-id: "not-set"
  client-secret: "not-set"

spring:
  application:
    name: bc-position
  datasource:
    url: jdbc:h2:mem:position;DB_CLOSE_DELAY=-1
  jpa:
    open-in-view: false
    hibernate:
      ddl-auto: update
  flyway:
    enabled: false
    baseline-on-migrate: true
    locations: classpath:db/migration
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${auth.uri}
      registration:
        custom:
          client-id: ${auth.client-id:not-set}
          client-secret: ${auth.client-secret}
          scope:
            - openid
            - profile
            - email
            - beancounter
            - beancounter:user
            - beancounter:system
          authorization-grant-type: client_credentials
  cloud:
    function:
      definition: performanceCacheInvalidation
    stream:
      # Switch between kafka and rabbit using environment variable:
      # SPRING_CLOUD_STREAM_DEFAULT_BINDER=kafka (or rabbit)
      default-binder: rabbit
      bindings:
        # Portfolio Market Value Producer (StreamBridge)
        portfolioMarketValue-out-0:
          destination: bc-pos-mv-dev
          content-type: application/json
        # Performance Cache Invalidation Consumer
        performanceCacheInvalidation-in-0:
          destination: bc-perf-invalidate-dev
          group: bc-position
          content-type: application/json
      # Kafka-specific configuration (when default-binder=kafka)
      kafka:
        binder:
          brokers: kafka:9092
      # RabbitMQ-specific configuration (when default-binder=rabbit)
      rabbit:
        binder:
          connection-name-prefix: bc-position
  rabbitmq:
    host: localhost
    port: 5672
    username: admin
    password: admin

  ai:
    mcp:
      server:
        name: beancounter-position
        version: 1.0.0
        type: SYNC
        stdio: false
        sse-message-endpoint: /mcp/message

logging:
  pattern:
    correlation: "[${spring.application.name:},%X{traceId:-},%X{spanId:-}] "
  include-application-name: false
  level:
    root: info
    javax: error
    sun: error
    io: error
    #io.github.resilience4j: debug
    netflix: error
    jdk: error
    okhttp3: error
    com:
      netfix: error
      beancounter: debug
      zaxxer: error
    org:
      springframework: error
      hibernate: error
      apache: error
      postgres: error

# Resilience4j configuration for svc-position
# Retry and circuit breaker for calls to bc-data service
resilience4j:
  circuitbreaker:
    configs:
      default:
        failureRateThreshold: 50
        slidingWindowSize: 20
        permittedNumberOfCallsInHalfOpenState: 5
        slidingWindowType: COUNT_BASED
        waitDurationInOpenState: 30s
        registerHealthIndicator: true
        recordFailurePredicate: com.beancounter.common.exception.RecordFailurePredicate

  retry:
    configs:
      default:
        maxRetryAttempts: 3
        waitDuration: 10s
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
        retryExceptions:
          - org.springframework.web.client.HttpServerErrorException
          - java.io.IOException
          - org.springframework.web.client.ResourceAccessException
        ignoreExceptions:
          - com.beancounter.common.exception.BusinessException
    instances:
      bcData:
        baseConfig: default
        maxRetryAttempts: 3

